<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SQ-80 Build-A-Bank Workshop</title>
    <!-- 
        <link href="https://fonts.cdnfonts.com/css/14-segment-led" rel="stylesheet"> 
     -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link href="https://db.onlinewebfonts.com/c/75714445b28a6caf0827d9dff9594cf6?family=F14+Segment+Alpha-Numeric+Led+Display" rel="stylesheet">
    <style>
        /* import fonts incase link in head fails */
        @import url('https://fonts.cdnfonts.com/css/14-segment-led');
        @import url(https://db.onlinewebfonts.com/c/75714445b28a6caf0827d9dff9594cf6?family=F14+Segment+Alpha-Numeric+Led+Display);
        :root {
            --bg: #121212; --panel: #1e1e1e; --accent: #4a90e2; 
            --text: #dcdcdc; --border: #333; --vfd: #5dade2; --esq-gold: #f1c40f;
            --instruction: #888;
            --glass-shine: rgba(255, 255, 255, 0.15);
            --glass-shadow: rgba(0, 0, 0, 0.4);
        }
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; display: flex; height: 100vh; overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar { 
            width: 380px; min-width: 300px; max-width: 800px;
            background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 12px; box-sizing: border-box;
            position: relative;
        }
        
        .sidebar-resizer {
            position: absolute; right: -3px; top: 0; width: 6px; height: 100%;
            cursor: col-resize; z-index: 100;
        }

        .tab-container { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 10px; gap: 0; }
        .tab {
            padding: 8px 12px; font-size: 10px; font-weight: 800; color: #888;
            text-transform: uppercase; cursor: pointer; border-radius: 4px 4px 0 0;
            background: #1a1a1a; transition: 0.2s;
            border: 1px solid #333; border-bottom: none; margin-right: 2px;
        }
        .tab:hover { color: var(--vfd); border-color: #444; }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Search Bar & Nav */
        .search-wrap { margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .search-row { display: flex; gap: 5px; }
        .search-input {
            flex: 1; background: #000; border: 1px solid var(--border);
            color: var(--vfd); padding: 6px 10px; border-radius: 4px;
            font-size: 11px; outline: none;
        }
        .search-nav-btn {
            background: #333; color: white; border: 1px solid #444;
            padding: 0 8px; border-radius: 4px; cursor: pointer; font-size: 10px;
        }
        .search-nav-btn:disabled { opacity: 0.3; cursor: default; }
        .match-counter { font-size: 9px; color: var(--accent); font-weight: bold; margin-top: 2px; }

        .file-list-container { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; overflow: hidden; }
        .list-box { background: #111; border: 1px solid var(--border); flex: 1; overflow: auto; border-radius: 4px; position: relative;}
        .tab-content { display: none; flex-direction: column; flex: 1; overflow: hidden; }
        .tab-content.active { display: flex; }

        table { width: 100%; border-collapse: collapse; font-size: 9px; table-layout: fixed; }
        th { 
            position: sticky; top: 0; background: #222; color: var(--accent); 
            text-align: left; padding: 5px; cursor: pointer; border-bottom: 2px solid var(--border);
            white-space: nowrap; overflow: hidden; z-index: 5;
        }
        th:hover { background: #333; color: #fff; }
        th.sort-active { color: var(--esq-gold); }
        
        td { padding: 4px 6px; border-bottom: 1px solid #222; white-space: nowrap; color: #aaa; overflow: hidden; text-overflow: ellipsis; }
        tr:hover td { background: #222; color: var(--vfd); cursor: pointer; }
        tr.search-highlight td { background: rgba(74, 144, 226, 0.2); color: #fff; border-left: 2px solid var(--accent); }
        tr.active-match td { background: rgba(241, 196, 15, 0.3); color: var(--esq-gold); }
        
        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 5px; cursor: col-resize; z-index: 10; }

        .btn { 
            background: linear-gradient(180deg, var(--glass-shine) 0%, rgba(255,255,255,0) 50%, var(--glass-shadow) 100%), var(--accent);
            color: white; border: 1px solid rgba(255,255,255,0.2); 
            padding: 10px; font-weight: bold; cursor: pointer; border-radius: 6px; font-size: 11px;
            text-shadow: 0px 1px 2px rgba(0,0,0,0.5);
            box-shadow: inset 1px 1px 1px rgba(255,255,255,0.3), 0px 4px 6px rgba(0,0,0,0.3);
            transition: all 0.1s ease; text-transform: uppercase; margin-top: 10px;
        }
        /* Dark Blue Variation of your Glass Button */
        .btn-blue {
            --accent-blue: #1a3a5f; /* Deep Navy/Dark Blue */
            background: linear-gradient(180deg, var(--glass-shine) 0%, rgba(255,255,255,0) 50%, var(--glass-shadow) 100%), var(--accent-blue) !important;
            border-color: rgba(74, 144, 226, 0.4) !important; /* Slight glow on the border */
        }

        .btn-blue:hover {
            filter: brightness(1.2);
            box-shadow: 0px 0px 8px rgba(74, 144, 226, 0.5);
        }

        .main-content { flex: 1; padding: 15px 25px; overflow-y: auto; display: flex; flex-direction: column; }
        .workflow-bridge { display: flex; align-items: center; justify-content: center; margin: 15px 0; gap: 15px; }
        .bridge-line { height: 3px; background: var(--accent); flex: 1; border-radius: 2px; }
        .bridge-text { font-size: 11px; font-weight: 700; color: var(--accent); white-space: nowrap; text-transform: uppercase; }
        .arrow-dn { color: var(--accent); font-size: 24px; font-weight: 900; }
        
        .bank-quadrant { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px; background: rgba(255,255,255,0.02); padding: 8px; border-radius: 6px; }
        .int-group { background: #000; padding: 6px; border: 1px solid #444; border-radius: 4px; }
        .int-header { font-size: 9px; color: var(--esq-gold); margin-bottom: 4px; font-weight: bold; }
        .patch-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; }
        
        .slot { 
            height: 30px; 
            background: #222; 
            border: 1px solid #333; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: grab; 
            position: relative;
            /* Default font */
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px; 
            color: var(--vfd); 
        }
        
        /* 1. The Base LED Font Class */
        .vfd-font {
            /* Fixed: Removed trailing comma */
            font-family: 'F14 Segment Alpha-Numeric Led Display', sans-serif !important;
            color: #64eefa !important;
            font-size: 16px; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* 2. Specific behavior for non-empty VFD slots */
        /* If you want the LED font to show, ensure VT323 isn't hijacking it here */
        .vfd-font:not(.empty) {
            font-family: 'F14 Segment Alpha-Numeric Led Display', sans-serif !important;
            color: #64eefa !important;
            font-size: 10px !important; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* 3. Keep empty slots clean */
        .slot.empty { 
            color: #333 !important; 
            font-family: 'JetBrains Mono', monospace !important; 
            font-size: 10px !important;
        }

        .slot:not(.empty):hover {
            border: 1px solid var(--accent) !important;
            background: rgba(74, 144, 226, 0.1);
        }

        /* The Switch Container (placed far right of heading) */
        .switch-wrap {
            float: right;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 9px;
            color: #777;
            margin-top: -2px;
        }

        /* Simple Slider CSS */
        .switch {
            position: relative; display: inline-block; width: 30px; height: 16px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 16px;
        }
        .slider:before {
            position: absolute; content: ""; height: 10px; width: 10px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(14px); }

        .rename-input { 
            position: absolute; width: 90%; height: 80%; background: #000; color: var(--esq-gold);
            border: 1px solid var(--accent); text-align: center; font-family: 'JetBrains Mono', monospace;
            font-size: 10px; text-transform: uppercase; outline: none; z-index: 5;
        }

        .workshop-area { background: #161616; padding: 12px; border-radius: 8px; border: 1px solid #222; }
        .scratch-compact { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; }
        #comment-box { background: #0a0a0a; border: 1px solid var(--accent); color: var(--vfd); padding: 8px 12px; height: 28px; font-size: 11px; margin-bottom: 12px; border-radius: 4px; display: flex; align-items: center; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: none;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: var(--panel); border: 1px solid var(--accent);
            padding: 25px; border-radius: 12px; width: 400px;
        }
        .modal-input {
            width:100%; margin-bottom:10px; background:#111; color:#fff; border:1px solid #444; padding:8px; box-sizing: border-box; font-size: 11px;
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-resizer" id="sidebar-resizer"></div>
        <div class="tab-container">
            <div id="tab-bank" class="tab active" onclick="switchTab('bank')">Bank Files</div>
            <div id="tab-single" class="tab" onclick="switchTab('single')">Single Patches</div>
        </div>

        <div class="search-wrap">
            <div class="search-row">
                <input type="text" id="lib-search" class="search-input" placeholder="Search Patch Names" oninput="handleSearchInput()">
                <button class="search-nav-btn" id="prev-btn" onclick="navSearch(-1)" title="Previous Match">▲</button>
                <button class="search-nav-btn" id="next-btn" onclick="navSearch(1)" title="Next Match">▼</button>
            </div>
            <div id="match-count" class="match-counter">0 matches found</div>
        </div>

        <div class="file-list-container">
            <div id="bank-tab" class="tab-content active"><div id="bank-list" class="list-box"></div></div>
            <div id="single-tab" class="tab-content"><div id="single-list" class="list-box"></div></div>
        </div>
        <button class="btn" onclick="openUploadModal()">Upload new bank or single patch</button>
    </div>

    <div class="main-content">
        <div id="comment-box">Metadata: Select a file to view internal patches...</div>
        
        <section>
            <h2 style="font-size: 12px; color: var(--vfd); margin-bottom: 4px; display: block; width: 100%;">
                Bank View (Source)
                <div class="switch-wrap">
                    <span>DEFAULT</span>
                    <label class="switch">
                        <input type="checkbox" id="font-toggle" onclick="toggleVfdFont()">
                        <span class="slider"></span>
                    </label>
                    <span>VFD</span>
                </div>
            </h2>            
            <div class="bank-quadrant">
                <div class="int-group"><div class="int-header">INT 1</div><div class="patch-grid" id="src-int-1"></div></div>
                <div class="int-group"><div class="int-header">INT 2</div><div class="patch-grid" id="src-int-2"></div></div>
                <div class="int-group"><div class="int-header">INT 3</div><div class="patch-grid" id="src-int-3"></div></div>
                <div class="int-group"><div class="int-header">INT 4</div><div class="patch-grid" id="src-int-4"></div></div>
            </div>
        </section>

        <div class="workflow-bridge">
            <div class="arrow-dn">▼</div><div class="bridge-line"></div>
            <div class="bridge-text">Drag patch names below to create custom bank</div>
            <div class="bridge-line"></div><div class="arrow-dn">▼</div>
        </div>

        <div class="workshop-area">
            <section>
                <h2 style="font-size: 12px; color: var(--vfd); margin-bottom: 4px;">Build-A-Bank</h2>
                <div class="bank-quadrant">
                    <div class="int-group"><div class="int-header">INT 1</div><div class="patch-grid" id="bld-int-1"></div></div>
                    <div class="int-group"><div class="int-header">INT 2</div><div class="patch-grid" id="bld-int-2"></div></div>
                    <div class="int-group"><div class="int-header">INT 3</div><div class="patch-grid" id="bld-int-3"></div></div>
                    <div class="int-group"><div class="int-header">INT 4</div><div class="patch-grid" id="bld-int-4"></div></div>
                </div>
            </section>

            <section>
                <h2 style="font-size: 10px; color: #777; margin-top: 8px;">Scratchpad - If needed, drag patches to these temporary  locations while you arrange your bank</h2>
                <div class="scratch-compact" id="placeholders"></div>
            </section>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
    
                <button class="btn btn-blue" style="width: auto; padding: 10px 20px;" onclick="displayParams()">
                    Display parameters for selected patch
                </button>
                
                <button class="btn" style="width: auto; padding: 10px 40px;" onclick="exportBank()">
                    Export Build-A-Bank (.syx)
                </button>
                
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <h3>Deposit SysEx to Library</h3>
            <form id="uploadForm">
                <input type="file" name="sysexFile" required style="width:100%; margin-bottom:15px;">
                <input type="text" name="userName" placeholder="Uploader Name" class="modal-input" required>
                <input type="text" name="origDate" placeholder="Original Creation Date (e.g. 1987)" class="modal-input">
                <textarea name="comments" placeholder="Comments..." class="modal-input" style="height: 60px;"></textarea>
                <button type="submit" class="btn" style="width: 100%;">Start Upload</button>
                <button type="button" class="btn" style="background:#555; width: 100%;" onclick="closeUploadModal()">Cancel</button>
            </form>
        </div>
    </div>

<!-- BEGIN close button and a container to  inject parameter display  -->
<div id="param-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:var(--panel); border:2px solid var(--vfd); width:90%; max-width:900px; padding:20px; border-radius:12px; position:relative; box-shadow: 0 0 30px rgba(0,0,0,0.5);">
        
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:20px;">
            <h3 id="overlay-patch-name" style="color:var(--vfd); margin:0; font-family:'VT323', monospace; font-size:24px;">PATCH PARAMETERS</h3>
            <button class="btn" style="margin:0; padding:5px 15px; background:#e74c3c;" onclick="closeParamOverlay()">CLOSE [ESC]</button>
        </div>

        <div id="param-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; max-height:70vh; overflow-y:auto; padding:10px;">
            </div>
    </div>
</div>
<!-- END close button and a container to  inject parameter display  -->


    <script>
        // track which patch is currently "active" or "highlighted"
        let selectedPatchData = null; // This will hold the {name, data} of the clicked patch
        // VFD display
        let vfdEnabled = false; // Global state

        let buildBank = new Array(40).fill(null);
        let scratchpad = new Array(8).fill(null);
        let currentSourcePatches = new Array(40).fill(null);
        let draggedPatch = null;
        let dragSourceInfo = null;
        let currentLibraryData = {};
        let activeRenameIdx = null;
        let currentTab = 'bank';
        
        let searchMatches = [];
        let currentMatchIdx = -1;

        // Sorting state
        let sortConfig = { key: 'name', direction: 'asc' };

        // Initialize Grids
        function initGrids() {
            for (let i=1; i<=4; i++) {
                const bldGrid = document.getElementById(`bld-int-${i}`);
                bldGrid.innerHTML = '';
                for (let j=0; j<10; j++) {
                    let idx = ((i-1)*10) + j;
                    bldGrid.appendChild(createSlot(idx, buildBank[idx], 'build'));
                }
                const srcGrid = document.getElementById(`src-int-${i}`);
                srcGrid.innerHTML = '';
                for (let j=0; j<10; j++) {
                    let idx = ((i-1)*10) + j;
                    srcGrid.appendChild(createSlot(idx, currentSourcePatches[idx], 'source'));
                }
            }
            const pGrid = document.getElementById('placeholders');
            pGrid.innerHTML = '';
            scratchpad.forEach((p, i) => pGrid.appendChild(createSlot(i, p, 'scratch')));
        }

        
        /* old displayParams in canse following one is bungled
        
        function displayParams() {
            // placeholder button area for parameter overlay
            // You can expand this to show an overlay or alert with patch data
            if (draggedPatch) {
                console.log("Current Patch Data:", draggedPatch.data);
                alert("Displaying parameters for: " + draggedPatch.name);
            } else {
                alert("Please select or drag a patch first.");
            }
        }
        
        */

        function displayParams() {
            if (!selectedPatchData) {
                alert("Please select a patch first!");
                return;
            }

            const overlay = document.getElementById('param-overlay');
            const grid = document.getElementById('param-grid');
            const nameHeader = document.getElementById('overlay-patch-name');

            nameHeader.innerText = `PATCH: ${selectedPatchData.name}`;
            grid.innerHTML = ''; // Clear old data

            // Example Mapping: ESQ-1/SQ-80 Byte offsets
            // Note: These are simplified examples. You'll want to map more of the 102 bytes.
            const paramMap = [
                { label: 'OSC 1 OCT', idx: 6 },
                { label: 'OSC 1 SEMI', idx: 7 },
                { label: 'OSC 1 WAVE', idx: 9 },
                { label: 'FILTER CUTOFF', idx: 38 },
                { label: 'FILTER Q', idx: 39 },
                { label: 'LFO 1 FREQ', idx: 58 }
            ];

            paramMap.forEach(p => {
                const val = selectedPatchData.data[p.idx];
                const card = document.createElement('div');
                card.style = "background:#111; padding:10px; border-left:3px solid var(--accent); border-radius:4px;";
                card.innerHTML = `
                    <div style="font-size:9px; color:#888; text-transform:uppercase;">${p.label}</div>
                    <div style="font-size:18px; color:var(--vfd); font-family:monospace;">${val}</div>
                `;
                grid.appendChild(card);
            });

            overlay.style.display = 'flex';
        }

        function closeParamOverlay() {
            document.getElementById('param-overlay').style.display = 'none';
        }

        // Global "Esc" key listener for quick dismissal
        window.addEventListener('keydown', (e) => {
            if (e.key === "Escape") closeParamOverlay();
        });

        function createSlot(idx, data, type) {
            const div = document.createElement('div');
            
            // 1. Establish classes. 
            // We check the global vfdEnabled variable here so that 
            // the font persists when initGrids() is called during drags/drops.
            div.className = `slot ${!data ? 'empty' : ''}`;
            
            if (vfdEnabled && data) {
                div.classList.add('vfd-font');
            }

            // 2. Set display text: Name for patches, indicator/index for empty
            div.innerText = data ? data.name : (type === 'scratch' ? '---' : idx + 1);
            
            // 3. Drag and Drop logic
            div.draggable = !!data;
            div.ondragstart = (e) => { 
                draggedPatch = data; 
                dragSourceInfo = { type, idx }; 
                // Optional: reduce opacity of the element being dragged
                e.target.style.opacity = "0.5";
            };
            
            div.ondragend = (e) => {
                e.target.style.opacity = "1";
            };

            div.ondragover = (e) => e.preventDefault();
            
            div.ondrop = (e) => { 
                e.preventDefault(); 
                handleDrop(idx, type); 
            };
            
            // 4. Rename logic for Build-A-Bank patches (double-click)
            if (type === 'build' && data) { 
                div.ondblclick = () => startRename(idx, div); 
            }

            // Add onclick listener for selecting single patch cells
            div.onclick = () => {
                if (data) selectPatch(data, div);
            };
            
            return div;
        }

        // --- SEARCH LOGIC ---
        function handleSearchInput() {
            const query = document.getElementById('lib-search').value.trim().toLowerCase();
            searchMatches = [];
            currentMatchIdx = -1;

            if (query.length < 2) {
                document.getElementById('match-count').innerText = "0 matches found";
                renderTable(`${currentTab}-list`, currentTab);
                return;
            }

            Object.entries(currentLibraryData).forEach(([filename, meta]) => {
                const foundInPatches = meta.patch_names && meta.patch_names.some(p => p.toLowerCase().includes(query));
                const foundInFile = filename.toLowerCase().includes(query);
                if (foundInPatches || foundInFile) {
                    searchMatches.push({ filename, type: meta.type });
                }
            });

            document.getElementById('match-count').innerText = `${searchMatches.length} matches found`;
            renderTable(`${currentTab}-list`, currentTab, query);
            document.getElementById('next-btn').disabled = searchMatches.length === 0;
            document.getElementById('prev-btn').disabled = searchMatches.length === 0;
        }

        function navSearch(dir) {
            if (searchMatches.length === 0) return;
            currentMatchIdx += dir;
            if (currentMatchIdx >= searchMatches.length) currentMatchIdx = 0;
            if (currentMatchIdx < 0) currentMatchIdx = searchMatches.length - 1;

            const target = searchMatches[currentMatchIdx];
            if (target.type !== currentTab) switchTab(target.type);
            
            renderTable(`${currentTab}-list`, currentTab, document.getElementById('lib-search').value.trim().toLowerCase());
            const row = document.querySelector(`tr[data-filename="${target.filename}"]`);
            if (row) {
                row.scrollIntoView({ block: 'center', behavior: 'smooth' });
                row.classList.add('active-match');
            }
        }

        // --- SORTING LOGIC ---
        function handleSort(key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            renderTable(`${currentTab}-list`, currentTab, document.getElementById('lib-search').value.trim());
        }

        function renderTable(containerId, typeFilter, query = "") {
            const container = document.getElementById(containerId);
            let files = Object.entries(currentLibraryData)
                .filter(([name, data]) => data.type === typeFilter)
                .map(([name, data]) => ({ 
                    name, 
                    date: data.date || '', 
                    original_date: data.original_date || '', 
                    user: data.user || '', 
                    comments: data.comments || '',
                    patch_names: data.patch_names || []
                }));

            // Apply Sort
            files.sort((a, b) => {
                let valA = a[sortConfig.key].toLowerCase();
                let valB = b[sortConfig.key].toLowerCase();
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });

            const getHeaderClass = (key) => sortConfig.key === key ? 'sort-active' : '';
            const getSortIndicator = (key) => sortConfig.key === key ? (sortConfig.direction === 'asc' ? ' ▴' : ' ▾') : '';

            let html = `<table><thead><tr>
                <th style="width:25%" class="${getHeaderClass('name')}" onclick="handleSort('name')">File${getSortIndicator('name')}</th>
                <th style="width:15%" class="${getHeaderClass('date')}" onclick="handleSort('date')">Uploaded${getSortIndicator('date')}</th>
                <th style="width:15%" class="${getHeaderClass('original_date')}" onclick="handleSort('original_date')">Orig Date${getSortIndicator('original_date')}</th>
                <th style="width:15%" class="${getHeaderClass('user')}" onclick="handleSort('user')">Author${getSortIndicator('user')}</th>
                <th style="width:30%">Comments</th>
            </tr></thead><tbody>`;

            files.forEach(f => {
                const queryLower = query.toLowerCase();
                const isMatch = query.length >= 2 && (f.name.toLowerCase().includes(queryLower) || (f.patch_names && f.patch_names.some(p => p.toLowerCase().includes(queryLower))));
                const isActive = searchMatches[currentMatchIdx] && searchMatches[currentMatchIdx].filename === f.name;
                
                let displayPatches = [];
                if (query.length >= 2 && f.patch_names) {
                    displayPatches = f.patch_names.filter(p => p.toLowerCase().includes(queryLower));
                }
                const toolTip = displayPatches.length > 0 ? "Matching: " + displayPatches.join(', ') : "Internal: " + (f.patch_names.length > 0 ? f.patch_names.slice(0, 5).join(', ') + '...' : 'N/A');

                html += `<tr data-filename="${f.name}" class="${isMatch ? 'search-highlight' : ''} ${isActive ? 'active-match' : ''}" 
                           onclick="loadFileToSource('${f.name}')" title="${toolTip}">
                    <td>${f.name}</td>
                    <td>${f.date || '--'}</td>
                    <td>${f.original_date || '--'}</td>
                    <td>${f.user || 'Anon'}</td>
                    <td>${f.comments || ''}</td>
                </tr>`;
            });
            container.innerHTML = html + `</tbody></table>`;
        }

        // --- UPLOAD HANDLER ---
        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch('upload.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.text();
                if (result.includes("Success")) {
                    alert(result);
                    closeUploadModal();
                    refreshLibrary();
                } else {
                    alert(result);
                }
            } catch (err) {
                alert("Network error occurred during upload.");
            }
        };

        async function loadFileToSource(filename) {
            const fileMeta = currentLibraryData[filename];
            document.getElementById('comment-box').innerText = `File: ${filename} | Author: ${fileMeta.user || 'Unknown'} | Original: ${fileMeta.original_date || 'Unknown'}`;
            try {
                const response = await fetch(`patches/${filename}`);
                const arrayBuffer = await response.arrayBuffer();
                const rawData = new Uint8Array(arrayBuffer);
                let sounds = [];
                for (let i = 5; i < rawData.length - 1; i += 2) { 
                    if (rawData[i+1] !== undefined) {
                        sounds.push((rawData[i+1] << 4) | (rawData[i] & 0x0F));
                    }
                }
                currentSourcePatches = new Array(40).fill(null);
                const isBank = sounds.length >= 4080;
                if (isBank) {
                    for (let p = 0; p < 40; p++) {
                        let pcb = sounds.slice(p * 102, (p + 1) * 102);
                        let nameChars = [];
                        for(let c=0; c<6; c++) nameChars.push(String.fromCharCode(pcb[c]));
                        currentSourcePatches[p] = { name: nameChars.join('').trim() || `BNK ${p+1}`, data: pcb };
                    }
                } else {
                    let nameChars = [];
                    for(let c=0; c<6; c++) nameChars.push(String.fromCharCode(sounds[c]));
                    currentSourcePatches[0] = { name: nameChars.join('').trim() || "SINGLE", data: sounds.slice(0, 102) };
                }
                initGrids();
            } catch (err) { console.error("Load fail", err); }
        }

        function switchTab(type) {
            currentTab = type;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${type}`).classList.add('active');
            document.getElementById(`${type}-tab`).classList.add('active');
            renderTable(`${currentTab}-list`, currentTab, document.getElementById('lib-search').value.trim());
        }

        async function refreshLibrary() {
            try {
                const response = await fetch('get_library.php');
                currentLibraryData = await response.json();
                renderTable('bank-list', 'bank');
                renderTable('single-list', 'single');
            } catch(e) { console.error("Sync error"); }
        }

        // Draggable sidebar
        const sidebar = document.getElementById('sidebar');
        const sidebarResizer = document.getElementById('sidebar-resizer');
        sidebarResizer.addEventListener('mousedown', (e) => {
            const onMouseMove = (me) => { sidebar.style.width = me.pageX + 'px'; };
            const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function handleDrop(targetIdx, targetType) {
            if (!draggedPatch) return;
            let targetArr = (targetType === 'build') ? buildBank : (targetType === 'scratch' ? scratchpad : null);
            if (!targetArr) return;
            if (dragSourceInfo.type === 'source') { targetArr[targetIdx] = JSON.parse(JSON.stringify(draggedPatch)); }
            else {
                let sourceArr = (dragSourceInfo.type === 'build') ? buildBank : scratchpad;
                let temp = targetArr[targetIdx];
                targetArr[targetIdx] = draggedPatch;
                sourceArr[dragSourceInfo.idx] = temp;
            }
            initGrids();
        }

        function startRename(idx, element) {
            if (activeRenameIdx !== null) return;
            activeRenameIdx = idx;
            const input = document.createElement('input');
            input.className = 'rename-input';
            input.value = buildBank[idx].name;
            const saveRename = () => {
                let val = input.value.toUpperCase().replace(/[^A-Z0-9!@#\$%\^&\*\(\)_\-\+=\[\]\{\}\\\|;:'",\.<>\/\? ]/g, "").substring(0,6).padEnd(6," ");
                buildBank[idx].name = val;
                for(let i=0; i<6; i++) { buildBank[idx].data[i] = val.charCodeAt(i); }
                activeRenameIdx = null; initGrids();
            };
            input.onblur = saveRename;
            input.onkeydown = (e) => { if (e.key === 'Enter') saveRename(); };
            element.innerText = ''; element.appendChild(input); input.focus(); input.select();
        }

        function exportBank() {
            let fileName = prompt("Bank Name:", "NEW_BANK.SYX");
            if (!fileName) return;
            if (!fileName.toUpperCase().endsWith(".SYX")) fileName += ".SYX";
            const header = [0xF0, 0x0F, 0x02, 0x01, 0x02];
            const nibbilizedData = [];
            let checksum = 0;
            for (let i = 0; i < 40; i++) {
                const patchBytes = buildBank[i] ? buildBank[i].data : new Array(102).fill(0);
                for (let j = 0; j < 102; j++) {
                    const byte = patchBytes[j];
                    const i1 = byte & 0x0F; const i2 = (byte >> 4) & 0x0F;
                    nibbilizedData.push(i1, i2); checksum = (checksum + i1 + i2) & 0x7F;
                }
            }
            const fullFile = new Uint8Array([...header, ...nibbilizedData, checksum, 0xF7]);
            const blob = new Blob([fullFile], { type: "application/octet-stream" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob); link.download = fileName; link.click();
        }


        // handle the visual highlighting and data assignment for selectinga  patch cell
        function selectPatch(data, element) {
            if (!data) return; // Don't select empty slots

            // 1. Remove "selected" class from all other slots
            document.querySelectorAll('.slot').forEach(s => s.style.border = "1px solid #333");
            document.querySelectorAll('.slot').forEach(s => s.style.boxShadow = "none");

            // 2. Highlight the clicked slot (SQ-80 Cyan Glow)
            element.style.border = "1px solid var(--vfd)";
            element.style.boxShadow = "0 0 8px rgba(93, 173, 226, 0.5)";

            // 3. Store the data for the "Display Parameters" button
            selectedPatchData = data;
            
            // Optional: Update the comment box to show what's selected
            document.getElementById('comment-box').innerText = `Selected: ${data.name} | Ready for Parameter View`;
        }

        function toggleVfdFont() {
            vfdEnabled = document.getElementById('font-toggle').checked;
            initGrids(); // This triggers createSlot for every cell
        }
        

        function openUploadModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function closeUploadModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        window.addEventListener('DOMContentLoaded', () => { initGrids(); refreshLibrary(); });
    </script>
</body>
</html>
